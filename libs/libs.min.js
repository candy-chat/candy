var Base64=(function(){var a="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=";var b={encode:function(e){var c="";var n,l,h;var m,j,g,f;var d=0;do{n=e.charCodeAt(d++);l=e.charCodeAt(d++);h=e.charCodeAt(d++);m=n>>2;j=((n&3)<<4)|(l>>4);g=((l&15)<<2)|(h>>6);f=h&63;if(isNaN(l)){g=f=64}else{if(isNaN(h)){f=64}}c=c+a.charAt(m)+a.charAt(j)+a.charAt(g)+a.charAt(f)}while(d<e.length);return c},decode:function(e){var c="";var n,l,h;var m,j,g,f;var d=0;e=e.replace(/[^A-Za-z0-9\+\/\=]/g,"");do{m=a.indexOf(e.charAt(d++));j=a.indexOf(e.charAt(d++));g=a.indexOf(e.charAt(d++));f=a.indexOf(e.charAt(d++));n=(m<<2)|(j>>4);l=((j&15)<<4)|(g>>2);h=((g&3)<<6)|f;c=c+String.fromCharCode(n);if(g!=64){c=c+String.fromCharCode(l)}if(f!=64){c=c+String.fromCharCode(h)}}while(d<e.length);return c}};return b})();var hexcase=0;var b64pad="=";var chrsz=8;function hex_sha1(a){return binb2hex(core_sha1(str2binb(a),a.length*chrsz))}function b64_sha1(a){return binb2b64(core_sha1(str2binb(a),a.length*chrsz))}function str_sha1(a){return binb2str(core_sha1(str2binb(a),a.length*chrsz))}function hex_hmac_sha1(a,b){return binb2hex(core_hmac_sha1(a,b))}function b64_hmac_sha1(a,b){return binb2b64(core_hmac_sha1(a,b))}function str_hmac_sha1(a,b){return binb2str(core_hmac_sha1(a,b))}function sha1_vm_test(){return hex_sha1("abc")=="a9993e364706816aba3e25717850c26c9cd0d89d"}function core_sha1(y,p){y[p>>5]|=128<<(24-p%32);y[((p+64>>9)<<4)+15]=p;var z=new Array(80);var v=1732584193;var u=-271733879;var s=-1732584194;var r=271733878;var q=-1009589776;var m,h,A,o,n,l,g,f;for(m=0;m<y.length;m+=16){o=v;n=u;l=s;g=r;f=q;for(h=0;h<80;h++){if(h<16){z[h]=y[m+h]}else{z[h]=rol(z[h-3]^z[h-8]^z[h-14]^z[h-16],1)}A=safe_add(safe_add(rol(v,5),sha1_ft(h,u,s,r)),safe_add(safe_add(q,z[h]),sha1_kt(h)));q=r;r=s;s=rol(u,30);u=v;v=A}v=safe_add(v,o);u=safe_add(u,n);s=safe_add(s,l);r=safe_add(r,g);q=safe_add(q,f)}return[v,u,s,r,q]}function sha1_ft(e,a,g,f){if(e<20){return(a&g)|((~a)&f)}if(e<40){return a^g^f}if(e<60){return(a&g)|(a&f)|(g&f)}return a^g^f}function sha1_kt(a){return(a<20)?1518500249:(a<40)?1859775393:(a<60)?-1894007588:-899497514}function core_hmac_sha1(c,f){var e=str2binb(c);if(e.length>16){e=core_sha1(e,c.length*chrsz)}var a=new Array(16),d=new Array(16);for(var b=0;b<16;b++){a[b]=e[b]^909522486;d[b]=e[b]^1549556828}var g=core_sha1(a.concat(str2binb(f)),512+f.length*chrsz);return core_sha1(d.concat(g),512+160)}function safe_add(a,d){var c=(a&65535)+(d&65535);var b=(a>>16)+(d>>16)+(c>>16);return(b<<16)|(c&65535)}function rol(a,b){return(a<<b)|(a>>>(32-b))}function str2binb(d){var c=[];var a=(1<<chrsz)-1;for(var b=0;b<d.length*chrsz;b+=chrsz){c[b>>5]|=(d.charCodeAt(b/chrsz)&a)<<(32-chrsz-b%32)}return c}function binb2str(c){var d="";var a=(1<<chrsz)-1;for(var b=0;b<c.length*32;b+=chrsz){d+=String.fromCharCode((c[b>>5]>>>(32-chrsz-b%32))&a)}return d}function binb2hex(c){var b=hexcase?"0123456789ABCDEF":"0123456789abcdef";var d="";for(var a=0;a<c.length*4;a++){d+=b.charAt((c[a>>2]>>((3-a%4)*8+4))&15)+b.charAt((c[a>>2]>>((3-a%4)*8))&15)}return d}function binb2b64(d){var c="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/";var f="";var e,a;for(var b=0;b<d.length*4;b+=3){e=(((d[b>>2]>>8*(3-b%4))&255)<<16)|(((d[b+1>>2]>>8*(3-(b+1)%4))&255)<<8)|((d[b+2>>2]>>8*(3-(b+2)%4))&255);for(a=0;a<4;a++){if(b*8+a*6>d.length*32){f+=b64pad}else{f+=c.charAt((e>>6*(3-a))&63)}}}return f}var MD5=(function(){var q=0;var a="";var n=8;var l=function(t,w){var v=(t&65535)+(w&65535);var u=(t>>16)+(w>>16)+(v>>16);return(u<<16)|(v&65535)};var p=function(t,u){return(t<<u)|(t>>>(32-u))};var b=function(w){var v=[];var t=(1<<n)-1;for(var u=0;u<w.length*n;u+=n){v[u>>5]|=(w.charCodeAt(u/n)&t)<<(u%32)}return v};var g=function(v){var w="";var t=(1<<n)-1;for(var u=0;u<v.length*32;u+=n){w+=String.fromCharCode((v[u>>5]>>>(u%32))&t)}return w};var s=function(v){var u=q?"0123456789ABCDEF":"0123456789abcdef";var w="";for(var t=0;t<v.length*4;t++){w+=u.charAt((v[t>>2]>>((t%4)*8+4))&15)+u.charAt((v[t>>2]>>((t%4)*8))&15)}return w};var r=function(w){var v="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/";var y="";var x,t;for(var u=0;u<w.length*4;u+=3){x=(((w[u>>2]>>8*(u%4))&255)<<16)|(((w[u+1>>2]>>8*((u+1)%4))&255)<<8)|((w[u+2>>2]>>8*((u+2)%4))&255);for(t=0;t<4;t++){if(u*8+t*6>w.length*32){y+=a}else{y+=v.charAt((x>>6*(3-t))&63)}}}return y};var d=function(A,w,v,u,z,y){return l(p(l(l(w,A),l(u,y)),z),v)};var m=function(w,v,B,A,u,z,y){return d((v&B)|((~v)&A),w,v,u,z,y)};var c=function(w,v,B,A,u,z,y){return d((v&A)|(B&(~A)),w,v,u,z,y)};var o=function(w,v,B,A,u,z,y){return d(v^B^A,w,v,u,z,y)};var j=function(w,v,B,A,u,z,y){return d(B^(v|(~A)),w,v,u,z,y)};var f=function(E,z){E[z>>5]|=128<<((z)%32);E[(((z+64)>>>9)<<4)+14]=z;var D=1732584193;var C=-271733879;var B=-1732584194;var A=271733878;var y,w,v,t;for(var u=0;u<E.length;u+=16){y=D;w=C;v=B;t=A;D=m(D,C,B,A,E[u+0],7,-680876936);A=m(A,D,C,B,E[u+1],12,-389564586);B=m(B,A,D,C,E[u+2],17,606105819);C=m(C,B,A,D,E[u+3],22,-1044525330);D=m(D,C,B,A,E[u+4],7,-176418897);A=m(A,D,C,B,E[u+5],12,1200080426);B=m(B,A,D,C,E[u+6],17,-1473231341);C=m(C,B,A,D,E[u+7],22,-45705983);D=m(D,C,B,A,E[u+8],7,1770035416);A=m(A,D,C,B,E[u+9],12,-1958414417);B=m(B,A,D,C,E[u+10],17,-42063);C=m(C,B,A,D,E[u+11],22,-1990404162);D=m(D,C,B,A,E[u+12],7,1804603682);A=m(A,D,C,B,E[u+13],12,-40341101);B=m(B,A,D,C,E[u+14],17,-1502002290);C=m(C,B,A,D,E[u+15],22,1236535329);D=c(D,C,B,A,E[u+1],5,-165796510);A=c(A,D,C,B,E[u+6],9,-1069501632);B=c(B,A,D,C,E[u+11],14,643717713);C=c(C,B,A,D,E[u+0],20,-373897302);D=c(D,C,B,A,E[u+5],5,-701558691);A=c(A,D,C,B,E[u+10],9,38016083);B=c(B,A,D,C,E[u+15],14,-660478335);C=c(C,B,A,D,E[u+4],20,-405537848);D=c(D,C,B,A,E[u+9],5,568446438);A=c(A,D,C,B,E[u+14],9,-1019803690);B=c(B,A,D,C,E[u+3],14,-187363961);C=c(C,B,A,D,E[u+8],20,1163531501);D=c(D,C,B,A,E[u+13],5,-1444681467);A=c(A,D,C,B,E[u+2],9,-51403784);B=c(B,A,D,C,E[u+7],14,1735328473);C=c(C,B,A,D,E[u+12],20,-1926607734);D=o(D,C,B,A,E[u+5],4,-378558);A=o(A,D,C,B,E[u+8],11,-2022574463);B=o(B,A,D,C,E[u+11],16,1839030562);C=o(C,B,A,D,E[u+14],23,-35309556);D=o(D,C,B,A,E[u+1],4,-1530992060);A=o(A,D,C,B,E[u+4],11,1272893353);B=o(B,A,D,C,E[u+7],16,-155497632);C=o(C,B,A,D,E[u+10],23,-1094730640);D=o(D,C,B,A,E[u+13],4,681279174);A=o(A,D,C,B,E[u+0],11,-358537222);B=o(B,A,D,C,E[u+3],16,-722521979);C=o(C,B,A,D,E[u+6],23,76029189);D=o(D,C,B,A,E[u+9],4,-640364487);A=o(A,D,C,B,E[u+12],11,-421815835);B=o(B,A,D,C,E[u+15],16,530742520);C=o(C,B,A,D,E[u+2],23,-995338651);D=j(D,C,B,A,E[u+0],6,-198630844);A=j(A,D,C,B,E[u+7],10,1126891415);B=j(B,A,D,C,E[u+14],15,-1416354905);C=j(C,B,A,D,E[u+5],21,-57434055);D=j(D,C,B,A,E[u+12],6,1700485571);A=j(A,D,C,B,E[u+3],10,-1894986606);B=j(B,A,D,C,E[u+10],15,-1051523);C=j(C,B,A,D,E[u+1],21,-2054922799);D=j(D,C,B,A,E[u+8],6,1873313359);A=j(A,D,C,B,E[u+15],10,-30611744);B=j(B,A,D,C,E[u+6],15,-1560198380);C=j(C,B,A,D,E[u+13],21,1309151649);D=j(D,C,B,A,E[u+4],6,-145523070);A=j(A,D,C,B,E[u+11],10,-1120210379);B=j(B,A,D,C,E[u+2],15,718787259);C=j(C,B,A,D,E[u+9],21,-343485551);D=l(D,y);C=l(C,w);B=l(B,v);A=l(A,t)}return[D,C,B,A]};var e=function(v,y){var x=b(v);if(x.length>16){x=f(x,v.length*n)}var t=new Array(16),w=new Array(16);for(var u=0;u<16;u++){t[u]=x[u]^909522486;w[u]=x[u]^1549556828}var z=f(t.concat(b(y)),512+y.length*n);return f(w.concat(z),512+128)};var h={hexdigest:function(t){return s(f(b(t),t.length*n))},b64digest:function(t){return r(f(b(t),t.length*n))},hash:function(t){return g(f(b(t),t.length*n))},hmac_hexdigest:function(t,u){return s(e(t,u))},hmac_b64digest:function(t,u){return r(e(t,u))},hmac_hash:function(t,u){return g(e(t,u))},test:function(){return MD5.hexdigest("abc")==="900150983cd24fb0d6963f7d28e17f72"}};return h})();if(!Function.prototype.bind){Function.prototype.bind=function(e){var d=this;var c=Array.prototype.slice;var b=Array.prototype.concat;var a=c.call(arguments,1);return function(){return d.apply(e?e:this,b.call(a,c.call(arguments,0)))}}}if(!Array.prototype.indexOf){Array.prototype.indexOf=function(b){var a=this.length;var c=Number(arguments[1])||0;c=(c<0)?Math.ceil(c):Math.floor(c);if(c<0){c+=a}for(;c<a;c++){if(c in this&&this[c]===b){return c}}return -1}}(function(f){var e;function c(h,g){return new e.Builder(h,g)}function a(g){return new e.Builder("message",g)}function d(g){return new e.Builder("iq",g)}function b(g){return new e.Builder("presence",g)}e={VERSION:"8861616",NS:{HTTPBIND:"http://jabber.org/protocol/httpbind",BOSH:"urn:xmpp:xbosh",CLIENT:"jabber:client",AUTH:"jabber:iq:auth",ROSTER:"jabber:iq:roster",PROFILE:"jabber:iq:profile",DISCO_INFO:"http://jabber.org/protocol/disco#info",DISCO_ITEMS:"http://jabber.org/protocol/disco#items",MUC:"http://jabber.org/protocol/muc",SASL:"urn:ietf:params:xml:ns:xmpp-sasl",STREAM:"http://etherx.jabber.org/streams",BIND:"urn:ietf:params:xml:ns:xmpp-bind",SESSION:"urn:ietf:params:xml:ns:xmpp-session",VERSION:"jabber:iq:version",STANZAS:"urn:ietf:params:xml:ns:xmpp-stanzas",XHTML_IM:"http://jabber.org/protocol/xhtml-im",XHTML:"http://www.w3.org/1999/xhtml"},XHTML:{tags:["a","blockquote","br","cite","em","img","li","ol","p","span","strong","ul","body"],attributes:{a:["href"],blockquote:["style"],br:[],cite:["style"],em:[],img:["src","alt","style","height","width"],li:["style"],ol:["style"],p:["style"],span:["style"],strong:[],ul:["style"],body:[]},css:["background-color","color","font-family","font-size","font-style","font-weight","margin-left","margin-right","text-align","text-decoration"],validTag:function(g){for(var h=0;h<e.XHTML.tags.length;h++){if(g==e.XHTML.tags[h]){return true}}return false},validAttribute:function(g,j){if(typeof e.XHTML.attributes[g]!=="undefined"&&e.XHTML.attributes[g].length>0){for(var h=0;h<e.XHTML.attributes[g].length;h++){if(j==e.XHTML.attributes[g][h]){return true}}}return false},validCSS:function(h){for(var g=0;g<e.XHTML.css.length;g++){if(h==e.XHTML.css[g]){return true}}return false}},addNamespace:function(g,h){e.NS[g]=h},Status:{ERROR:0,CONNECTING:1,CONNFAIL:2,AUTHENTICATING:3,AUTHFAIL:4,CONNECTED:5,DISCONNECTED:6,DISCONNECTING:7,ATTACHED:8},LogLevel:{DEBUG:0,INFO:1,WARN:2,ERROR:3,FATAL:4},ElementType:{NORMAL:1,TEXT:3,CDATA:4,FRAGMENT:11},TIMEOUT:1.1,SECONDARY_TIMEOUT:0.1,forEachChild:function(l,m,j){var h,g;for(h=0;h<l.childNodes.length;h++){g=l.childNodes[h];if(g.nodeType==e.ElementType.NORMAL&&(!m||this.isTagEqual(g,m))){j(g)}}},isTagEqual:function(h,g){return h.tagName.toLowerCase()==g.toLowerCase()},_xmlGenerator:null,_makeGenerator:function(){var g;if(document.implementation.createDocument===undefined||document.implementation.createDocument&&document.documentMode&&document.documentMode<10){g=this._getIEXmlDom();g.appendChild(g.createElement("strophe"))}else{g=document.implementation.createDocument("jabber:client","strophe",null)}return g},xmlGenerator:function(){if(!e._xmlGenerator){e._xmlGenerator=e._makeGenerator()}return e._xmlGenerator},_getIEXmlDom:function(){var h=null;var l=["Msxml2.DOMDocument.6.0","Msxml2.DOMDocument.5.0","Msxml2.DOMDocument.4.0","MSXML2.DOMDocument.3.0","MSXML2.DOMDocument","MSXML.DOMDocument","Microsoft.XMLDOM"];for(var j=0;j<l.length;j++){if(h===null){try{h=new ActiveXObject(l[j])}catch(g){h=null}}else{break}}return h},xmlElement:function(j){if(!j){return null}var m=e.xmlGenerator().createElement(j);var g,l,h;for(g=1;g<arguments.length;g++){if(!arguments[g]){continue}if(typeof(arguments[g])=="string"||typeof(arguments[g])=="number"){m.appendChild(e.xmlTextNode(arguments[g]))}else{if(typeof(arguments[g])=="object"&&typeof(arguments[g].sort)=="function"){for(l=0;l<arguments[g].length;l++){if(typeof(arguments[g][l])=="object"&&typeof(arguments[g][l].sort)=="function"){m.setAttribute(arguments[g][l][0],arguments[g][l][1])}}}else{if(typeof(arguments[g])=="object"){for(h in arguments[g]){if(arguments[g].hasOwnProperty(h)){m.setAttribute(h,arguments[g][h])}}}}}}return m},xmlescape:function(g){g=g.replace(/\&/g,"&amp;");g=g.replace(/</g,"&lt;");g=g.replace(/>/g,"&gt;");g=g.replace(/'/g,"&apos;");g=g.replace(/"/g,"&quot;");return g},xmlTextNode:function(g){g=e.xmlescape(g);return e.xmlGenerator().createTextNode(g)},xmlHtmlNode:function(g){if(window.DOMParser){parser=new DOMParser();node=parser.parseFromString(g,"text/xml")}else{node=new ActiveXObject("Microsoft.XMLDOM");node.async="false";node.loadXML(g)}return node},getText:function(h){if(!h){return null}var j="";if(h.childNodes.length===0&&h.nodeType==e.ElementType.TEXT){j+=h.nodeValue}for(var g=0;g<h.childNodes.length;g++){if(h.childNodes[g].nodeType==e.ElementType.TEXT){j+=h.childNodes[g].nodeValue}}return e.xmlescape(j)},copyElement:function(j){var g,h;if(j.nodeType==e.ElementType.NORMAL){h=e.xmlElement(j.tagName);for(g=0;g<j.attributes.length;g++){h.setAttribute(j.attributes[g].nodeName.toLowerCase(),j.attributes[g].value)}for(g=0;g<j.childNodes.length;g++){h.appendChild(e.copyElement(j.childNodes[g]))}}else{if(j.nodeType==e.ElementType.TEXT){h=e.xmlGenerator().createTextNode(j.nodeValue)}}return h},createHtml:function(n){var q,m,o,x,l,w,s,t,v,p,r,h,g;if(n.nodeType==e.ElementType.NORMAL){x=n.nodeName.toLowerCase();if(e.XHTML.validTag(x)){try{m=e.xmlElement(x);for(q=0;q<e.XHTML.attributes[x].length;q++){l=e.XHTML.attributes[x][q];w=n.getAttribute(l);if(typeof w=="undefined"||w===null||w===""||w===false||w===0){continue}if(l=="style"&&typeof w=="object"){if(typeof w.cssText!="undefined"){w=w.cssText}}if(l=="style"){s=[];t=w.split(";");for(o=0;o<t.length;o++){v=t[o].split(":");p=v[0].replace(/^\s*/,"").replace(/\s*$/,"").toLowerCase();if(e.XHTML.validCSS(p)){r=v[1].replace(/^\s*/,"").replace(/\s*$/,"");s.push(p+": "+r)}}if(s.length>0){w=s.join("; ");m.setAttribute(l,w)}}else{m.setAttribute(l,w)}}for(q=0;q<n.childNodes.length;q++){m.appendChild(e.createHtml(n.childNodes[q]))}}catch(u){m=e.xmlTextNode("")}}else{m=e.xmlGenerator().createDocumentFragment();for(q=0;q<n.childNodes.length;q++){m.appendChild(e.createHtml(n.childNodes[q]))}}}else{if(n.nodeType==e.ElementType.FRAGMENT){m=e.xmlGenerator().createDocumentFragment();for(q=0;q<n.childNodes.length;q++){m.appendChild(e.createHtml(n.childNodes[q]))}}else{if(n.nodeType==e.ElementType.TEXT){m=e.xmlTextNode(n.nodeValue)}}}return m},escapeNode:function(g){return g.replace(/^\s+|\s+$/g,"").replace(/\\/g,"\\5c").replace(/ /g,"\\20").replace(/\"/g,"\\22").replace(/\&/g,"\\26").replace(/\'/g,"\\27").replace(/\//g,"\\2f").replace(/:/g,"\\3a").replace(/</g,"\\3c").replace(/>/g,"\\3e").replace(/@/g,"\\40")},unescapeNode:function(g){return g.replace(/\\20/g," ").replace(/\\22/g,'"').replace(/\\26/g,"&").replace(/\\27/g,"'").replace(/\\2f/g,"/").replace(/\\3a/g,":").replace(/\\3c/g,"<").replace(/\\3e/g,">").replace(/\\40/g,"@").replace(/\\5c/g,"\\")},getNodeFromJid:function(g){if(g.indexOf("@")<0){return null}return g.split("@")[0]},getDomainFromJid:function(g){var h=e.getBareJidFromJid(g);if(h.indexOf("@")<0){return h}else{var j=h.split("@");j.splice(0,1);return j.join("@")}},getResourceFromJid:function(g){var h=g.split("/");if(h.length<2){return null}h.splice(0,1);return h.join("/")},getBareJidFromJid:function(g){return g?g.split("/")[0]:null},log:function(h,g){return},debug:function(g){this.log(this.LogLevel.DEBUG,g)},info:function(g){this.log(this.LogLevel.INFO,g)},warn:function(g){this.log(this.LogLevel.WARN,g)},error:function(g){this.log(this.LogLevel.ERROR,g)},fatal:function(g){this.log(this.LogLevel.FATAL,g)},serialize:function(j){var g;if(!j){return null}if(typeof(j.tree)==="function"){j=j.tree()}var m=j.nodeName;var h,l;if(j.getAttribute("_realname")){m=j.getAttribute("_realname")}g="<"+m;for(h=0;h<j.attributes.length;h++){if(j.attributes[h].nodeName!="_realname"){g+=" "+j.attributes[h].nodeName.toLowerCase()+"='"+j.attributes[h].value.replace(/&/g,"&amp;").replace(/\'/g,"&apos;").replace(/>/g,"&gt;").replace(/</g,"&lt;")+"'"}}if(j.childNodes.length>0){g+=">";for(h=0;h<j.childNodes.length;h++){l=j.childNodes[h];switch(l.nodeType){case e.ElementType.NORMAL:g+=e.serialize(l);break;case e.ElementType.TEXT:g+=l.nodeValue;break;case e.ElementType.CDATA:g+="<![CDATA["+l.nodeValue+"]]>"}}g+="</"+m+">"}else{g+="/>"}return g},_requestId:0,_connectionPlugins:{},addConnectionPlugin:function(g,h){e._connectionPlugins[g]=h}};e.Builder=function(h,g){if(h=="presence"||h=="message"||h=="iq"){if(g&&!g.xmlns){g.xmlns=e.NS.CLIENT}else{if(!g){g={xmlns:e.NS.CLIENT}}}}this.nodeTree=e.xmlElement(h,g);this.node=this.nodeTree};e.Builder.prototype={tree:function(){return this.nodeTree},toString:function(){return e.serialize(this.nodeTree)},up:function(){this.node=this.node.parentNode;return this},attrs:function(h){for(var g in h){if(h.hasOwnProperty(g)){this.node.setAttribute(g,h[g])}}return this},c:function(h,g,j){var l=e.xmlElement(h,g,j);this.node.appendChild(l);if(!j){this.node=l}return this},cnode:function(j){var m=e.xmlGenerator();try{var h=(m.importNode!==undefined)}catch(l){var h=false}var g=h?m.importNode(j,true):e.copyElement(j);this.node.appendChild(g);this.node=g;return this},t:function(g){var h=e.xmlTextNode(g);this.node.appendChild(h);return this},h:function(h){var g=document.createElement("body");g.innerHTML=h;var j=e.createHtml(g);while(j.childNodes.length>0){this.node.appendChild(j.childNodes[0])}return this}};e.Handler=function(m,l,h,j,o,n,g){this.handler=m;this.ns=l;this.name=h;this.type=j;this.id=o;this.options=g||{matchbare:false};if(!this.options.matchBare){this.options.matchBare=false}if(this.options.matchBare){this.from=n?e.getBareJidFromJid(n):null}else{this.from=n}this.user=true};e.Handler.prototype={isMatch:function(h){var l;var j=null;if(this.options.matchBare){j=e.getBareJidFromJid(h.getAttribute("from"))}else{j=h.getAttribute("from")}l=false;if(!this.ns){l=true}else{var g=this;e.forEachChild(h,null,function(m){if(m.getAttribute("xmlns")==g.ns){l=true}});l=l||h.getAttribute("xmlns")==this.ns}if(l&&(!this.name||e.isTagEqual(h,this.name))&&(!this.type||h.getAttribute("type")==this.type)&&(!this.id||h.getAttribute("id")==this.id)&&(!this.from||j==this.from)){return true}return false},run:function(h){var g=null;try{g=this.handler(h)}catch(j){if(j.sourceURL){e.fatal("error: "+this.handler+" "+j.sourceURL+":"+j.line+" - "+j.name+": "+j.message)}else{if(j.fileName){if(typeof(console)!="undefined"){console.trace();console.error(this.handler," - error - ",j,j.message)}e.fatal("error: "+this.handler+" "+j.fileName+":"+j.lineNumber+" - "+j.name+": "+j.message)}else{e.fatal("error: "+j.message+"\n"+j.stack)}}throw j}return g},toString:function(){return"{Handler: "+this.handler+"("+this.name+","+this.id+","+this.ns+")}"}};e.TimedHandler=function(h,g){this.period=h;this.handler=g;this.lastCalled=new Date().getTime();this.user=true};e.TimedHandler.prototype={run:function(){this.lastCalled=new Date().getTime();return this.handler()},reset:function(){this.lastCalled=new Date().getTime()},toString:function(){return"{TimedHandler: "+this.handler+"("+this.period+")}"}};e.Request=function(j,h,g,l){this.id=++e._requestId;this.xmlData=j;this.data=e.serialize(j);this.origFunc=h;this.func=h;this.rid=g;this.date=NaN;this.sends=l||0;this.abort=false;this.dead=null;this.age=function(){if(!this.date){return 0}var m=new Date();return(m-this.date)/1000};this.timeDead=function(){if(!this.dead){return 0}var m=new Date();return(m-this.dead)/1000};this.xhr=this._newXHR()};e.Request.prototype={getResponse:function(){var g=null;if(this.xhr.responseXML&&this.xhr.responseXML.documentElement){g=this.xhr.responseXML.documentElement;if(g.tagName=="parsererror"){e.error("invalid response received");e.error("responseText: "+this.xhr.responseText);e.error("responseXML: "+e.serialize(this.xhr.responseXML));throw"parsererror"}}else{if(this.xhr.responseText){e.error("invalid response received");e.error("responseText: "+this.xhr.responseText);e.error("responseXML: "+e.serialize(this.xhr.responseXML))}}return g},_newXHR:function(){var g=null;if(window.XMLHttpRequest){g=new XMLHttpRequest();if(g.overrideMimeType){g.overrideMimeType("text/xml")}}else{if(window.ActiveXObject){g=new ActiveXObject("Microsoft.XMLHTTP")}}g.onreadystatechange=this.func.bind(null,this);return g}};e.Connection=function(g){this.service=g;this.jid="";this.domain=null;this.rid=Math.floor(Math.random()*4294967295);this.sid=null;this.streamId=null;this.features=null;this._sasl_data=[];this.do_session=false;this.do_bind=false;this.timedHandlers=[];this.handlers=[];this.removeTimeds=[];this.removeHandlers=[];this.addTimeds=[];this.addHandlers=[];this._authentication={};this._idleTimeout=null;this._disconnectTimeout=null;this.do_authentication=true;this.authenticated=false;this.disconnecting=false;this.connected=false;this.errors=0;this.paused=false;this.hold=1;this.wait=60;this.window=5;this._data=[];this._requests=[];this._uniqueId=Math.round(Math.random()*10000);this._sasl_success_handler=null;this._sasl_failure_handler=null;this._sasl_challenge_handler=null;this.maxRetries=5;this._idleTimeout=setTimeout(this._onIdle.bind(this),100);for(var h in e._connectionPlugins){if(e._connectionPlugins.hasOwnProperty(h)){var l=e._connectionPlugins[h];var j=function(){};j.prototype=l;this[h]=new j();this[h].init(this)}}};e.Connection.prototype={reset:function(){this.rid=Math.floor(Math.random()*4294967295);this.sid=null;this.streamId=null;this.do_session=false;this.do_bind=false;this.timedHandlers=[];this.handlers=[];this.removeTimeds=[];this.removeHandlers=[];this.addTimeds=[];this.addHandlers=[];this._authentication={};this.authenticated=false;this.disconnecting=false;this.connected=false;this.errors=0;this._requests=[];this._uniqueId=Math.round(Math.random()*10000)},pause:function(){this.paused=true},resume:function(){this.paused=false},getUniqueId:function(g){if(typeof(g)=="string"||typeof(g)=="number"){return ++this._uniqueId+":"+g}else{return ++this._uniqueId+""}},connect:function(j,m,p,o,n,h){this.jid=j;this.pass=m;this.connect_callback=p;this.disconnecting=false;this.connected=false;this.authenticated=false;this.errors=0;this.wait=o||this.wait;this.hold=n||this.hold;this.domain=this.domain||e.getDomainFromJid(this.jid);var g=this._buildBody().attrs({to:this.domain,"xml:lang":"en",wait:this.wait,hold:this.hold,content:"text/xml; charset=utf-8",ver:"1.6","xmpp:version":"1.0","xmlns:xmpp":e.NS.BOSH});if(h){g.attrs({route:h})}this._changeConnectStatus(e.Status.CONNECTING,null);var l=this._connect_callback||this._connect_cb;this._connect_callback=null;this._requests.push(new e.Request(g.tree(),this._onRequestStateChange.bind(this,l.bind(this)),g.tree().getAttribute("rid")));this._throttledRequestHandler()},attach:function(j,g,l,o,n,m,h){this.jid=j;this.sid=g;this.rid=l;this.connect_callback=o;this.domain=e.getDomainFromJid(this.jid);this.authenticated=true;this.connected=true;this.wait=n||this.wait;this.hold=m||this.hold;this.window=h||this.window;this._changeConnectStatus(e.Status.ATTACHED,null)},xmlInput:function(g){return},xmlOutput:function(g){return},rawInput:function(g){return},rawOutput:function(g){return},send:function(h){if(h===null){return}if(typeof(h.sort)==="function"){for(var g=0;g<h.length;g++){this._queueData(h[g])}}else{if(typeof(h.tree)==="function"){this._queueData(h.tree())}else{this._queueData(h)}}this._throttledRequestHandler();clearTimeout(this._idleTimeout);this._idleTimeout=setTimeout(this._onIdle.bind(this),100)},flush:function(){clearTimeout(this._idleTimeout);this._onIdle()},sendIQ:function(l,p,g,m){var n=null;var j=this;if(typeof(l.tree)==="function"){l=l.tree()}var o=l.getAttribute("id");if(!o){o=this.getUniqueId("sendIQ");l.setAttribute("id",o)}var h=this.addHandler(function(r){if(n){j.deleteTimedHandler(n)}var q=r.getAttribute("type");if(q=="result"){if(p){p(r)}}else{if(q=="error"){if(g){g(r)}}else{throw {name:"StropheError",message:"Got bad IQ type of "+q}}}},null,"iq",null,o);if(m){n=this.addTimedHandler(m,function(){j.deleteHandler(h);if(g){g(null)}return false})}this.send(l);return o},_queueData:function(g){if(g===null||!g.tagName||!g.childNodes){throw {name:"StropheError",message:"Cannot queue non-DOMElement."}}this._data.push(g)},_sendRestart:function(){this._data.push("restart");this._throttledRequestHandler();clearTimeout(this._idleTimeout);this._idleTimeout=setTimeout(this._onIdle.bind(this),100)},addTimedHandler:function(j,h){var g=new e.TimedHandler(j,h);this.addTimeds.push(g);return g},deleteTimedHandler:function(g){this.removeTimeds.push(g)},addHandler:function(n,m,j,l,p,o,h){var g=new e.Handler(n,m,j,l,p,o,h);this.addHandlers.push(g);return g},deleteHandler:function(g){this.removeHandlers.push(g)},disconnect:function(g){this._changeConnectStatus(e.Status.DISCONNECTING,g);e.info("Disconnect was called because: "+g);if(this.connected){this._disconnectTimeout=this._addSysTimedHandler(3000,this._onDisconnectTimeout.bind(this));this._sendTerminate()}},_changeConnectStatus:function(g,n){for(var h in e._connectionPlugins){if(e._connectionPlugins.hasOwnProperty(h)){var l=this[h];if(l.statusChanged){try{l.statusChanged(g,n)}catch(j){e.error(""+h+" plugin caused an exception changing status: "+j)}}}}if(this.connect_callback){try{this.connect_callback(g,n)}catch(m){e.error("User connection callback caused an exception: "+m)}}},_buildBody:function(){var g=c("body",{rid:this.rid++,xmlns:e.NS.HTTPBIND});if(this.sid!==null){g.attrs({sid:this.sid})}return g},_removeRequest:function(h){e.debug("removing request");var g;for(g=this._requests.length-1;g>=0;g--){if(h==this._requests[g]){this._requests.splice(g,1)}}h.xhr.onreadystatechange=function(){};this._throttledRequestHandler()},_restartRequest:function(g){var h=this._requests[g];if(h.dead===null){h.dead=new Date()}this._processRequest(g)},_processRequest:function(l){var q=this._requests[l];var t=-1;try{if(q.xhr.readyState==4){t=q.xhr.status}}catch(o){e.error("caught an error in _requests["+l+"], reqStatus: "+t)}if(typeof(t)=="undefined"){t=-1}if(q.sends>this.maxRetries){this._onDisconnectTimeout();return}var j=q.age();var h=(!isNaN(j)&&j>Math.floor(e.TIMEOUT*this.wait));var m=(q.dead!==null&&q.timeDead()>Math.floor(e.SECONDARY_TIMEOUT*this.wait));var s=(q.xhr.readyState==4&&(t<1||t>=500));if(h||m||s){if(m){e.error("Request "+this._requests[l].id+" timed out (secondary), restarting")}q.abort=true;q.xhr.abort();q.xhr.onreadystatechange=function(){};this._requests[l]=new e.Request(q.xmlData,q.origFunc,q.rid,q.sends);q=this._requests[l]}if(q.xhr.readyState===0){e.debug("request id "+q.id+"."+q.sends+" posting");try{var g=!("sync" in this&&this.sync===true);q.xhr.open("POST",this.service,g)}catch(p){e.error("XHR open failed.");if(!this.connected){this._changeConnectStatus(e.Status.CONNFAIL,"bad-service")}this.disconnect();return}var r=function(){q.date=new Date();q.xhr.send(q.data)};if(q.sends>1){var n=Math.min(Math.floor(e.TIMEOUT*this.wait),Math.pow(q.sends,3))*1000;setTimeout(r,n)}else{r()}q.sends++;if(this.xmlOutput!==e.Connection.prototype.xmlOutput){this.xmlOutput(q.xmlData)}if(this.rawOutput!==e.Connection.prototype.rawOutput){this.rawOutput(q.data)}}else{e.debug("_processRequest: "+(l===0?"first":"second")+" request has readyState of "+q.xhr.readyState)}},_throttledRequestHandler:function(){if(!this._requests){e.debug("_throttledRequestHandler called with undefined requests")}else{e.debug("_throttledRequestHandler called with "+this._requests.length+" requests")}if(!this._requests||this._requests.length===0){return}if(this._requests.length>0){this._processRequest(0)}if(this._requests.length>1&&Math.abs(this._requests[0].rid-this._requests[1].rid)<this.window){this._processRequest(1)}},_onRequestStateChange:function(l,j){e.debug("request id "+j.id+"."+j.sends+" state changed to "+j.xhr.readyState);if(j.abort){j.abort=false;return}var h;if(j.xhr.readyState==4){h=0;try{h=j.xhr.status}catch(m){}if(typeof(h)=="undefined"){h=0}if(this.disconnecting){if(h>=400){this._hitError(h);return}}var g=(this._requests[0]==j);var n=(this._requests[1]==j);if((h>0&&h<500)||j.sends>5){this._removeRequest(j);e.debug("request id "+j.id+" should now be removed")}if(h==200){if(n||(g&&this._requests.length>0&&this._requests[0].age()>Math.floor(e.SECONDARY_TIMEOUT*this.wait))){this._restartRequest(0)}e.debug("request id "+j.id+"."+j.sends+" got 200");l(j);this.errors=0}else{e.error("request id "+j.id+"."+j.sends+" error "+h+" happened");if(h===0||(h>=400&&h<600)||h>=12000){this._hitError(h);if(h>=400&&h<500){this._changeConnectStatus(e.Status.DISCONNECTING,null);this._doDisconnect()}}}if(!((h>0&&h<500)||j.sends>5)){this._throttledRequestHandler()}}},_hitError:function(g){this.errors++;e.warn("request errored, status: "+g+", number of errors: "+this.errors);if(this.errors>4){this._onDisconnectTimeout()}},_doDisconnect:function(){e.info("_doDisconnect was called");this.authenticated=false;this.disconnecting=false;this.sid=null;this.streamId=null;this.rid=Math.floor(Math.random()*4294967295);if(this.connected){this._changeConnectStatus(e.Status.DISCONNECTED,null);this.connected=false}this.handlers=[];this.timedHandlers=[];this.removeTimeds=[];this.removeHandlers=[];this.addTimeds=[];this.addHandlers=[]},_dataRecv:function(q){try{var g=q.getResponse()}catch(o){if(o!="parsererror"){throw o}this.disconnect("strophe-parsererror")}if(g===null){return}if(this.xmlInput!==e.Connection.prototype.xmlInput){this.xmlInput(g)}if(this.rawInput!==e.Connection.prototype.rawInput){this.rawInput(e.serialize(g))}var m,j;while(this.removeHandlers.length>0){j=this.removeHandlers.pop();m=this.handlers.indexOf(j);if(m>=0){this.handlers.splice(m,1)}}while(this.addHandlers.length>0){this.handlers.push(this.addHandlers.pop())}if(this.disconnecting&&this._requests.length===0){this.deleteTimedHandler(this._disconnectTimeout);this._disconnectTimeout=null;this._doDisconnect();return}var h=g.getAttribute("type");var p,l;if(h!==null&&h=="terminate"){if(this.disconnecting){return}p=g.getAttribute("condition");l=g.getElementsByTagName("conflict");if(p!==null){if(p=="remote-stream-error"&&l.length>0){p="conflict"}this._changeConnectStatus(e.Status.CONNFAIL,p)}else{this._changeConnectStatus(e.Status.CONNFAIL,"unknown")}this.disconnect();return}var n=this;e.forEachChild(g,null,function(v){var s,t;t=n.handlers;n.handlers=[];for(s=0;s<t.length;s++){var r=t[s];try{if(r.isMatch(v)&&(n.authenticated||!r.user)){if(r.run(v)){n.handlers.push(r)}}else{n.handlers.push(r)}}catch(u){}}})},_sendTerminate:function(){e.info("_sendTerminate was called");var g=this._buildBody().attrs({type:"terminate"});if(this.authenticated){g.c("presence",{xmlns:e.NS.CLIENT,type:"unavailable"})}this.disconnecting=true;var h=new e.Request(g.tree(),this._onRequestStateChange.bind(this,this._dataRecv.bind(this)),g.tree().getAttribute("rid"));this._requests.push(h);this._throttledRequestHandler()},_connect_cb:function(g,n){e.info("_connect_cb was called");this.connected=true;var y=g.getResponse();if(!y){return}if(this.xmlInput!==e.Connection.prototype.xmlInput){this.xmlInput(y)}if(this.rawInput!==e.Connection.prototype.rawInput){this.rawInput(e.serialize(y))}var z=y.getAttribute("type");var p,u;if(z!==null&&z=="terminate"){p=y.getAttribute("condition");u=y.getElementsByTagName("conflict");if(p!==null){if(p=="remote-stream-error"&&u.length>0){p="conflict"}this._changeConnectStatus(e.Status.CONNFAIL,p)}else{this._changeConnectStatus(e.Status.CONNFAIL,"unknown")}return}if(!this.sid){this.sid=y.getAttribute("sid")}if(!this.stream_id){this.stream_id=y.getAttribute("authid")}var h=y.getAttribute("requests");if(h){this.window=parseInt(h,10)}var r=y.getAttribute("hold");if(r){this.hold=parseInt(r,10)}var v=y.getAttribute("wait");if(v){this.wait=parseInt(v,10)}this._authentication.sasl_scram_sha1=false;this._authentication.sasl_plain=false;this._authentication.sasl_digest_md5=false;this._authentication.sasl_anonymous=false;this._authentication.legacy_auth=false;var w=y.getElementsByTagName("stream:features").length>0;if(!w){w=y.getElementsByTagName("features").length>0}var q=y.getElementsByTagName("mechanism");var x,t,j,l,s=false;if(w&&q.length>0){var m=0;for(x=0;x<q.length;x++){t=e.getText(q[x]);if(t=="SCRAM-SHA-1"){this._authentication.sasl_scram_sha1=true}else{if(t=="DIGEST-MD5"){this._authentication.sasl_digest_md5=true}else{if(t=="PLAIN"){this._authentication.sasl_plain=true}else{if(t=="ANONYMOUS"){this._authentication.sasl_anonymous=true}else{m++}}}}}this._authentication.legacy_auth=y.getElementsByTagName("auth").length>0;s=this._authentication.legacy_auth||m<q.length}if(!s){n=n||this._connect_cb;var o=this._buildBody();this._requests.push(new e.Request(o.tree(),this._onRequestStateChange.bind(this,n.bind(this)),o.tree().getAttribute("rid")));this._throttledRequestHandler();return}if(this.do_authentication!==false){this.authenticate()}},authenticate:function(){if(e.getNodeFromJid(this.jid)===null&&this._authentication.sasl_anonymous){this._changeConnectStatus(e.Status.AUTHENTICATING,null);this._sasl_success_handler=this._addSysHandler(this._sasl_success_cb.bind(this),null,"success",null,null);this._sasl_failure_handler=this._addSysHandler(this._sasl_failure_cb.bind(this),null,"failure",null,null);this.send(c("auth",{xmlns:e.NS.SASL,mechanism:"ANONYMOUS"}).tree())}else{if(e.getNodeFromJid(this.jid)===null){this._changeConnectStatus(e.Status.CONNFAIL,"x-strophe-bad-non-anon-jid");this.disconnect()}else{if(this._authentication.sasl_scram_sha1){var h=MD5.hexdigest(Math.random()*1234567890);var g="n="+e.getNodeFromJid(this.jid);g+=",r=";g+=h;this._sasl_data.cnonce=h;this._sasl_data["client-first-message-bare"]=g;g="n,,"+g;this._changeConnectStatus(e.Status.AUTHENTICATING,null);this._sasl_challenge_handler=this._addSysHandler(this._sasl_scram_challenge_cb.bind(this),null,"challenge",null,null);this._sasl_failure_handler=this._addSysHandler(this._sasl_failure_cb.bind(this),null,"failure",null,null);this.send(c("auth",{xmlns:e.NS.SASL,mechanism:"SCRAM-SHA-1"}).t(Base64.encode(g)).tree())}else{if(this._authentication.sasl_digest_md5){this._changeConnectStatus(e.Status.AUTHENTICATING,null);this._sasl_challenge_handler=this._addSysHandler(this._sasl_digest_challenge1_cb.bind(this),null,"challenge",null,null);this._sasl_failure_handler=this._addSysHandler(this._sasl_failure_cb.bind(this),null,"failure",null,null);this.send(c("auth",{xmlns:e.NS.SASL,mechanism:"DIGEST-MD5"}).tree())}else{if(this._authentication.sasl_plain){g=unescape(encodeURIComponent(e.getBareJidFromJid(this.jid)));g=g+"\u0000";g=g+unescape(encodeURIComponent(e.getNodeFromJid(this.jid)));g=g+"\u0000";g=g+this.pass;this._changeConnectStatus(e.Status.AUTHENTICATING,null);this._sasl_success_handler=this._addSysHandler(this._sasl_success_cb.bind(this),null,"success",null,null);this._sasl_failure_handler=this._addSysHandler(this._sasl_failure_cb.bind(this),null,"failure",null,null);hashed_auth_str=Base64.encode(g);this.send(c("auth",{xmlns:e.NS.SASL,mechanism:"PLAIN"}).t(hashed_auth_str).tree())}else{this._changeConnectStatus(e.Status.AUTHENTICATING,null);this._addSysHandler(this._auth1_cb.bind(this),null,null,null,"_auth_1");this.send(d({type:"get",to:this.domain,id:"_auth_1"}).c("query",{xmlns:e.NS.AUTH}).c("username",{}).t(e.getNodeFromJid(this.jid)).tree())}}}}}},_sasl_digest_challenge1_cb:function(m){var h=/([a-z]+)=("[^"]+"|[^,"]+)(?:,|$)/;var s=Base64.decode(e.getText(m));var t=MD5.hexdigest(""+(Math.random()*1234567890));var p="";var u=null;var q="";var g="";var o;this.deleteHandler(this._sasl_failure_handler);while(s.match(h)){o=s.match(h);s=s.replace(o[0],"");o[2]=o[2].replace(/^"(.+)"$/,"$1");switch(o[1]){case"realm":p=o[2];break;case"nonce":q=o[2];break;case"qop":g=o[2];break;case"host":u=o[2];break}}var n="xmpp/"+this.domain;if(u!==null){n=n+"/"+u}var l=MD5.hash(unescape(encodeURIComponent(e.getNodeFromJid(this.jid)))+":"+p+":"+this.pass)+":"+q+":"+t;var j="AUTHENTICATE:"+n;var r="";r+="username="+this._quote(unescape(encodeURIComponent(e.getNodeFromJid(this.jid))))+",";r+="realm="+this._quote(p)+",";r+="nonce="+this._quote(q)+",";r+="cnonce="+this._quote(t)+",";r+='nc="00000001",';r+='qop="auth",';r+="digest-uri="+this._quote(n)+",";r+="response="+this._quote(MD5.hexdigest(MD5.hexdigest(l)+":"+q+":00000001:"+t+":auth:"+MD5.hexdigest(j)))+",";r+='charset="utf-8"';this._sasl_challenge_handler=this._addSysHandler(this._sasl_digest_challenge2_cb.bind(this),null,"challenge",null,null);this._sasl_success_handler=this._addSysHandler(this._sasl_success_cb.bind(this),null,"success",null,null);this._sasl_failure_handler=this._addSysHandler(this._sasl_failure_cb.bind(this),null,"failure",null,null);this.send(c("response",{xmlns:e.NS.SASL}).t(Base64.encode(r)).tree());return false},_quote:function(g){return'"'+g.replace(/\\/g,"\\\\").replace(/"/g,'\\"')+'"'},_sasl_digest_challenge2_cb:function(g){this.deleteHandler(this._sasl_success_handler);this.deleteHandler(this._sasl_failure_handler);this._sasl_success_handler=this._addSysHandler(this._sasl_success_cb.bind(this),null,"success",null,null);this._sasl_failure_handler=this._addSysHandler(this._sasl_failure_cb.bind(this),null,"failure",null,null);this.send(c("response",{xmlns:e.NS.SASL}).tree());return false},_sasl_scram_challenge_cb:function(j){var q,o,s,n,l,g;var p,w,m;var r="c=biws,";var t=Base64.decode(e.getText(j));var u=this._sasl_data["client-first-message-bare"]+","+t+",";var v=this._sasl_data.cnonce;var h=/([a-z]+)=([^,]+)(,|$)/;this.deleteHandler(this._sasl_failure_handler);while(t.match(h)){matches=t.match(h);t=t.replace(matches[0],"");switch(matches[1]){case"r":q=matches[2];break;case"s":o=matches[2];break;case"i":s=matches[2];break}}if(!(q.substr(0,v.length)===v)){this._sasl_data=[];return this._sasl_failure_cb(null)}r+="r="+q;u+=r;o=Base64.decode(o);o+="\0\0\0\1";n=g=core_hmac_sha1(this.pass,o);for(i=1;i<s;i++){l=core_hmac_sha1(this.pass,binb2str(g));for(k=0;k<5;k++){n[k]^=l[k]}g=l}n=binb2str(n);p=core_hmac_sha1(n,"Client Key");w=str_hmac_sha1(n,"Server Key");m=core_hmac_sha1(str_sha1(binb2str(p)),u);this._sasl_data["server-signature"]=b64_hmac_sha1(w,u);for(k=0;k<5;k++){p[k]^=m[k]}r+=",p="+Base64.encode(binb2str(p));this._sasl_success_handler=this._addSysHandler(this._sasl_success_cb.bind(this),null,"success",null,null);this._sasl_failure_handler=this._addSysHandler(this._sasl_failure_cb.bind(this),null,"failure",null,null);this.send(c("response",{xmlns:e.NS.SASL}).t(Base64.encode(r)).tree());return false},_auth1_cb:function(g){var h=d({type:"set",id:"_auth_2"}).c("query",{xmlns:e.NS.AUTH}).c("username",{}).t(e.getNodeFromJid(this.jid)).up().c("password").t(this.pass);if(!e.getResourceFromJid(this.jid)){this.jid=e.getBareJidFromJid(this.jid)+"/strophe"}h.up().c("resource",{}).t(e.getResourceFromJid(this.jid));this._addSysHandler(this._auth2_cb.bind(this),null,null,null,"_auth_2");this.send(h.tree());return false},_sasl_success_cb:function(h){if(this._sasl_data["server-signature"]){var g;var l=Base64.decode(e.getText(h));var j=/([a-z]+)=([^,]+)(,|$)/;matches=l.match(j);if(matches[1]=="v"){g=matches[2]}if(g!=this._sasl_data["server-signature"]){this.deleteHandler(this._sasl_failure_handler);this._sasl_failure_handler=null;if(this._sasl_challenge_handler){this.deleteHandler(this._sasl_challenge_handler);this._sasl_challenge_handler=null}this._sasl_data=[];return this._sasl_failure_cb(null)}}e.info("SASL authentication succeeded.");this.deleteHandler(this._sasl_failure_handler);this._sasl_failure_handler=null;if(this._sasl_challenge_handler){this.deleteHandler(this._sasl_challenge_handler);this._sasl_challenge_handler=null}this._addSysHandler(this._sasl_auth1_cb.bind(this),null,"stream:features",null,null);this._sendRestart();return false},_sasl_auth1_cb:function(h){this.features=h;var g,l;for(g=0;g<h.childNodes.length;g++){l=h.childNodes[g];if(l.nodeName=="bind"){this.do_bind=true}if(l.nodeName=="session"){this.do_session=true}}if(!this.do_bind){this._changeConnectStatus(e.Status.AUTHFAIL,null);return false}else{this._addSysHandler(this._sasl_bind_cb.bind(this),null,null,null,"_bind_auth_2");var j=e.getResourceFromJid(this.jid);if(j){this.send(d({type:"set",id:"_bind_auth_2"}).c("bind",{xmlns:e.NS.BIND}).c("resource",{}).t(j).tree())}else{this.send(d({type:"set",id:"_bind_auth_2"}).c("bind",{xmlns:e.NS.BIND}).tree())}}return false},_sasl_bind_cb:function(g){if(g.getAttribute("type")=="error"){e.info("SASL binding failed.");var h=g.getElementsByTagName("conflict"),m;if(h.length>0){m="conflict"}this._changeConnectStatus(e.Status.AUTHFAIL,m);return false}var l=g.getElementsByTagName("bind");var j;if(l.length>0){j=l[0].getElementsByTagName("jid");if(j.length>0){this.jid=e.getText(j[0]);if(this.do_session){this._addSysHandler(this._sasl_session_cb.bind(this),null,null,null,"_session_auth_2");this.send(d({type:"set",id:"_session_auth_2"}).c("session",{xmlns:e.NS.SESSION}).tree())}else{this.authenticated=true;this._changeConnectStatus(e.Status.CONNECTED,null)}}}else{e.info("SASL binding failed.");this._changeConnectStatus(e.Status.AUTHFAIL,null);return false}},_sasl_session_cb:function(g){if(g.getAttribute("type")=="result"){this.authenticated=true;this._changeConnectStatus(e.Status.CONNECTED,null)}else{if(g.getAttribute("type")=="error"){e.info("Session creation failed.");this._changeConnectStatus(e.Status.AUTHFAIL,null);return false}}return false},_sasl_failure_cb:function(g){if(this._sasl_success_handler){this.deleteHandler(this._sasl_success_handler);this._sasl_success_handler=null}if(this._sasl_challenge_handler){this.deleteHandler(this._sasl_challenge_handler);this._sasl_challenge_handler=null}this._changeConnectStatus(e.Status.AUTHFAIL,null);return false},_auth2_cb:function(g){if(g.getAttribute("type")=="result"){this.authenticated=true;this._changeConnectStatus(e.Status.CONNECTED,null)}else{if(g.getAttribute("type")=="error"){this._changeConnectStatus(e.Status.AUTHFAIL,null);this.disconnect()}}return false},_addSysTimedHandler:function(j,h){var g=new e.TimedHandler(j,h);g.user=false;this.addTimeds.push(g);return g},_addSysHandler:function(m,l,h,j,n){var g=new e.Handler(m,l,h,j,n);g.user=false;this.addHandlers.push(g);return g},_onDisconnectTimeout:function(){e.info("_onDisconnectTimeout was called");var g;while(this._requests.length>0){g=this._requests.pop();g.abort=true;g.xhr.abort();g.xhr.onreadystatechange=function(){}}this._doDisconnect();return false},_onIdle:function(){var j,m,o,l;while(this.addTimeds.length>0){this.timedHandlers.push(this.addTimeds.pop())}while(this.removeTimeds.length>0){m=this.removeTimeds.pop();j=this.timedHandlers.indexOf(m);if(j>=0){this.timedHandlers.splice(j,1)}}var h=new Date().getTime();l=[];for(j=0;j<this.timedHandlers.length;j++){m=this.timedHandlers[j];if(this.authenticated||!m.user){o=m.lastCalled+m.period;if(o-h<=0){if(m.run()){l.push(m)}}else{l.push(m)}}}this.timedHandlers=l;var g,n;if(this.authenticated&&this._requests.length===0&&this._data.length===0&&!this.disconnecting){e.info("no requests during idle cycle, sending blank request");this._data.push(null)}if(this._requests.length<2&&this._data.length>0&&!this.paused){g=this._buildBody();for(j=0;j<this._data.length;j++){if(this._data[j]!==null){if(this._data[j]==="restart"){g.attrs({to:this.domain,"xml:lang":"en","xmpp:restart":"true","xmlns:xmpp":e.NS.BOSH})}else{g.cnode(this._data[j]).up()}}}delete this._data;this._data=[];this._requests.push(new e.Request(g.tree(),this._onRequestStateChange.bind(this,this._dataRecv.bind(this)),g.tree().getAttribute("rid")));this._processRequest(this._requests.length-1)}if(this._requests.length>0){n=this._requests[0].age();if(this._requests[0].dead!==null){if(this._requests[0].timeDead()>Math.floor(e.SECONDARY_TIMEOUT*this.wait)){this._throttledRequestHandler()}}if(n>Math.floor(e.TIMEOUT*this.wait)){e.warn("Request "+this._requests[0].id+" timed out, over "+Math.floor(e.TIMEOUT*this.wait)+" seconds since last activity");this._throttledRequestHandler()}}clearTimeout(this._idleTimeout);if(this.connected){this._idleTimeout=setTimeout(this._onIdle.bind(this),100)}}};if(f){f(e,c,a,d,b)}})(function(){window.Strophe=arguments[0];window.$build=arguments[1];window.$msg=arguments[2];window.$iq=arguments[3];window.$pres=arguments[4]});(function(){var b,c,d,a=function(e,f){return function(){return e.apply(f,arguments)}};Strophe.addConnectionPlugin("muc",{_connection:null,rooms:[],init:function(e){this._connection=e;this._muc_handler=null;Strophe.addNamespace("MUC_OWNER",Strophe.NS.MUC+"#owner");Strophe.addNamespace("MUC_ADMIN",Strophe.NS.MUC+"#admin");Strophe.addNamespace("MUC_USER",Strophe.NS.MUC+"#user");return Strophe.addNamespace("MUC_ROOMCONF",Strophe.NS.MUC+"#roomconfig")},join:function(e,f,l,j,o,p){var g,m,n,h=this;m=this.test_append_nick(e,f);g=$pres({from:this._connection.jid,to:m}).c("x",{xmlns:Strophe.NS.MUC});if(p!=null){g.cnode(Strophe.xmlElement("password",[],p))}if(this._muc_handler==null){this._muc_handler=this._connection.addHandler(function(r){var A,B,s,q,t,z,u,w,v,y;A=r.getAttribute("from");t=A.split("/")[0];if(!h.rooms[t]){return true}e=h.rooms[t];s={};if(r.nodeName==="message"){s=e._message_handlers}else{if(r.nodeName==="presence"){w=r.getElementsByTagName("x");if(w.length>0){for(v=0,y=w.length;v<y;v++){z=w[v];u=z.getAttribute("xmlns");if(u&&u.match(Strophe.NS.MUC)){s=e._presence_handlers;break}}}}}for(q in s){B=s[q];if(!B(r,e)){delete s[q]}}return true})}if((n=this.rooms)[e]==null){n[e]=new d(this,e,f,p)}if(j){this.rooms[e].addHandler("presence",j)}if(l){this.rooms[e].addHandler("message",l)}if(o){this.rooms[e].addHandler("roster",o)}return this._connection.send(g)},leave:function(m,e,h,f){var g,j,l;delete this.rooms[m];if(this.rooms.length===0){this._connection.deleteHandler(this._muc_handler);this._muc_handler=null}l=this.test_append_nick(m,e);j=this._connection.getUniqueId();g=$pres({type:"unavailable",id:j,from:this._connection.jid,to:l});if(f!=null){g.c("status",f)}if(h!=null){this._connection.addHandler(h,null,"presence",null,j)}this._connection.send(g);return j},message:function(e,h,o,f,l){var j,g,n,m;m=this.test_append_nick(e,h);l=l||(h!=null?"chat":"groupchat");g=this._connection.getUniqueId();j=$msg({to:m,from:this._connection.jid,type:l,id:g}).c("body",{xmlns:Strophe.NS.CLIENT}).t(o);j.up();if(f!=null){j.c("html",{xmlns:Strophe.NS.XHTML_IM}).c("body",{xmlns:Strophe.NS.XHTML}).h(f);if(j.node.childNodes.length===0){n=j.node.parentNode;j.up().up();j.node.removeChild(n)}else{j.up().up()}}j.c("x",{xmlns:"jabber:x:event"}).c("composing");this._connection.send(j);return g},groupchat:function(g,e,f){return this.message(g,null,e,f)},invite:function(j,f,h){var g,e;e=this._connection.getUniqueId();g=$msg({from:this._connection.jid,to:j,id:e}).c("x",{xmlns:Strophe.NS.MUC_USER}).c("invite",{to:f});if(h!=null){g.c("reason",h)}this._connection.send(g);return e},directInvite:function(m,h,l,f){var e,j,g;g=this._connection.getUniqueId();e={xmlns:"jabber:x:conference",jid:m};if(l!=null){e.reason=l}if(f!=null){e.password=f}j=$msg({from:this._connection.jid,to:h,id:g}).c("x",e);this._connection.send(j);return g},queryOccupants:function(j,e,g){var f,h;f={xmlns:Strophe.NS.DISCO_ITEMS};h=$iq({from:this._connection.jid,to:j,type:"get"}).c("query",f);return this._connection.sendIQ(h,e,g)},configure:function(g,f){var e,j,h;e=$iq({to:g,type:"get"}).c("query",{xmlns:Strophe.NS.MUC_OWNER});h=e.tree();j=this._connection.sendIQ(h);if(f!=null){this._connection.addHandler(function(l){f(l);return false},Strophe.NS.MUC_OWNER,"iq",null,j)}return j},cancelConfigure:function(f){var e,g;e=$iq({to:f,type:"set"}).c("query",{xmlns:Strophe.NS.MUC_OWNER}).c("x",{xmlns:"jabber:x:data",type:"cancel"});g=e.tree();return this._connection.sendIQ(g)},saveConfiguration:function(l,j){var g,f,m,h,e;f=$iq({to:l,type:"set"}).c("query",{xmlns:Strophe.NS.MUC_OWNER}).c("x",{xmlns:"jabber:x:data",type:"submit"});for(h=0,e=j.length;h<e;h++){g=j[h];f.cnode(g).up()}m=f.tree();return this._connection.sendIQ(m)},createInstantRoom:function(f){var e;e=$iq({to:f,type:"set"}).c("query",{xmlns:Strophe.NS.MUC_OWNER}).c("x",{xmlns:"jabber:x:data",type:"submit"});return this._connection.sendIQ(e.tree())},setTopic:function(f,e){var g;g=$msg({to:f,from:this._connection.jid,type:"groupchat"}).c("subject",{xmlns:"jabber:client"}).t(e);return this._connection.send(g.tree())},_modifyPrivilege:function(l,g,j,e,f){var h;h=$iq({to:l,type:"set"}).c("query",{xmlns:Strophe.NS.MUC_ADMIN}).cnode(g.node);if(j!=null){h.c("reason",j)}return this._connection.sendIQ(h.tree(),e,f)},modifyRole:function(l,e,m,j,f,h){var g;g=$build("item",{nick:e,role:m});return this._modifyPrivilege(l,g,j,f,h)},kick:function(j,e,h,f,g){return this.modifyRole(j,e,"none",h,f,g)},voice:function(j,e,h,f,g){return this.modifyRole(j,e,"participant",h,f,g)},mute:function(j,e,h,f,g){return this.modifyRole(j,e,"visitor",h,f,g)},op:function(j,e,h,f,g){return this.modifyRole(j,e,"moderator",h,f,g)},deop:function(j,e,h,f,g){return this.modifyRole(j,e,"participant",h,f,g)},modifyAffiliation:function(m,f,g,l,e,j){var h;h=$build("item",{jid:f,affiliation:g});return this._modifyPrivilege(m,h,l,e,j)},ban:function(j,f,h,e,g){return this.modifyAffiliation(j,f,"outcast",h,e,g)},member:function(j,f,h,e,g){return this.modifyAffiliation(j,f,"member",h,e,g)},revoke:function(j,f,h,e,g){return this.modifyAffiliation(j,f,"none",h,e,g)},owner:function(j,f,h,e,g){return this.modifyAffiliation(j,f,"owner",h,e,g)},admin:function(j,f,h,e,g){return this.modifyAffiliation(j,f,"admin",h,e,g)},changeNick:function(h,e){var f,g;g=this.test_append_nick(h,e);f=$pres({from:this._connection.jid,to:g,id:this._connection.getUniqueId()});return this._connection.send(f.tree())},setStatus:function(l,g,f,e){var h,j;j=this.test_append_nick(l,g);h=$pres({from:this._connection.jid,to:j});if(f!=null){h.c("show",f).up()}if(e!=null){h.c("status",e)}return this._connection.send(h.tree())},listRooms:function(g,e){var f;f=$iq({to:g,from:this._connection.jid,type:"get"}).c("query",{xmlns:Strophe.NS.DISCO_ITEMS});return this._connection.sendIQ(f,e)},test_append_nick:function(f,e){return f+(e!=null?"/"+(Strophe.escapeNode(e)):"")}});d=(function(){e.prototype.roster={};e.prototype._message_handlers={};e.prototype._presence_handlers={};e.prototype._roster_handlers={};e.prototype._handler_ids=0;function e(g,j,f,h){this.client=g;this.name=j;this.nick=f;this.password=h;this._roomRosterHandler=a(this._roomRosterHandler,this);this._addOccupant=a(this._addOccupant,this);if(g.muc){this.client=g.muc}this.name=Strophe.getBareJidFromJid(j);this.client.rooms[this.name]=this;this.addHandler("presence",this._roomRosterHandler)}e.prototype.join=function(f,g){if(!this.client.rooms[this.name]){return this.client.join(this.name,this.nick,f,g,this.password)}};e.prototype.leave=function(f,g){this.client.leave(this.name,this.nick,f,g);return delete this.client.rooms[this.name]};e.prototype.message=function(f,h,j,g){return this.client.message(this.name,f,h,j,g)};e.prototype.groupchat=function(f,g){return this.client.groupchat(this.name,f,g)};e.prototype.invite=function(f,g){return this.client.invite(this.name,f,g)};e.prototype.directInvite=function(f,g){return this.client.directInvite(this.name,f,g,this.password)};e.prototype.configure=function(f){return this.client.configure(this.name,f)};e.prototype.cancelConfigure=function(){return this.client.cancelConfigure(this.name)};e.prototype.saveConfiguration=function(f){return this.client.saveConfiguration(this.name,f)};e.prototype.queryOccupants=function(f,g){return this.client.queryOccupants(this.name,f,g)};e.prototype.setTopic=function(f){return this.client.setTopic(this.name,f)};e.prototype.modifyRole=function(f,l,j,g,h){return this.client.modifyRole(this.name,f,l,j,g,h)};e.prototype.kick=function(f,j,g,h){return this.client.kick(this.name,f,j,g,h)};e.prototype.voice=function(f,j,g,h){return this.client.voice(this.name,f,j,g,h)};e.prototype.mute=function(f,j,g,h){return this.client.mute(this.name,f,j,g,h)};e.prototype.op=function(f,j,g,h){return this.client.op(this.name,f,j,g,h)};e.prototype.deop=function(f,j,g,h){return this.client.deop(this.name,f,j,g,h)};e.prototype.modifyAffiliation=function(g,h,l,f,j){return this.client.modifyAffiliation(this.name,g,h,l,f,j)};e.prototype.ban=function(g,j,f,h){return this.client.ban(this.name,g,j,f,h)};e.prototype.member=function(g,j,f,h){return this.client.member(this.name,g,j,f,h)};e.prototype.revoke=function(g,j,f,h){return this.client.revoke(this.name,g,j,f,h)};e.prototype.owner=function(g,j,f,h){return this.client.owner(this.name,g,j,f,h)};e.prototype.admin=function(g,j,f,h){return this.client.admin(this.name,g,j,f,h)};e.prototype.changeNick=function(f){this.nick=f;return this.client.changeNick(this.name,f)};e.prototype.setStatus=function(g,f){return this.client.setStatus(this.name,this.nick,g,f)};e.prototype.addHandler=function(g,f){var h;h=this._handler_ids++;switch(g){case"presence":this._presence_handlers[h]=f;break;case"message":this._message_handlers[h]=f;break;case"roster":this._roster_handlers[h]=f;break;default:this._handler_ids--;return null}return h};e.prototype.removeHandler=function(f){delete this._presence_handlers[f];delete this._message_handlers[f];return delete this._roster_handlers[f]};e.prototype._addOccupant=function(g){var f;f=new b(g,this);this.roster[f.nick]=f;return f};e.prototype._roomRosterHandler=function(m){var l,h,n,g,f,j;l=e._parsePresence(m);f=l.nick;g=l.newnick||null;switch(l.type){case"error":return;case"unavailable":if(g){l.nick=g;if(this.roster[f]&&this.roster[g]){this.roster[f].update(this.roster[g]);this.roster[g]=this.roster[f]}if(this.roster[f]&&!this.roster[g]){this.roster[g]=this.roster[f].update(l)}}delete this.roster[f];break;default:if(this.roster[f]){this.roster[f].update(l)}else{this._addOccupant(l)}}j=this._roster_handlers;for(n in j){h=j[n];if(!h(this.roster,this)){delete this._roster_handlers[n]}}return true};e._parsePresence=function(t){var w,v,r,u,q,p,x,h,s,o,n,m,l,j,g,f;u={};w=t.attributes;u.nick=Strophe.getResourceFromJid(w.from.textContent);u.type=((s=w.type)!=null?s.textContent:void 0)||null;u.states=[];o=t.childNodes;for(q=0,x=o.length;q<x;q++){v=o[q];switch(v.nodeName){case"status":u.status=v.textContent||null;break;case"show":u.show=v.textContent||null;break;case"x":w=v.attributes;if(((n=w.xmlns)!=null?n.textContent:void 0)===Strophe.NS.MUC_USER){m=v.childNodes;for(p=0,h=m.length;p<h;p++){r=m[p];switch(r.nodeName){case"item":w=r.attributes;u.affiliation=((l=w.affiliation)!=null?l.textContent:void 0)||null;u.role=((j=w.role)!=null?j.textContent:void 0)||null;u.jid=((g=w.jid)!=null?g.textContent:void 0)||null;u.newnick=((f=w.nick)!=null?f.textContent:void 0)||null;break;case"status":if(r.attributes.code){u.states.push(r.attributes.code.textContent)}}}}}}return u};return e})();c=(function(){function e(f){this.parse=a(this.parse,this);if(f!=null){this.parse(f)}}e.prototype.parse=function(u){var o,t,h,s,p,q,m,l,j,r,g,f,n;q=u.getElementsByTagName("query")[0].childNodes;this.identities=[];this.features=[];this.x=[];for(m=0,r=q.length;m<r;m++){h=q[m];t=h.attributes;switch(h.nodeName){case"identity":p={};for(l=0,g=t.length;l<g;l++){o=t[l];p[o.name]=o.textContent}this.identities.push(p);break;case"feature":this.features.push(t["var"].textContent);break;case"x":t=h.childNodes[0].attributes;if((!t["var"].textContent==="FORM_TYPE")||(!t.type.textContent==="hidden")){break}n=h.childNodes;for(j=0,f=n.length;j<f;j++){s=n[j];if(!(!s.attributes.type)){continue}t=s.attributes;this.x.push({"var":t["var"].textContent,label:t.label.textContent||"",value:s.firstChild.textContent||""})}}}return{identities:this.identities,features:this.features,x:this.x}};return e})();b=(function(){function e(f,g){this.room=g;this.update=a(this.update,this);this.admin=a(this.admin,this);this.owner=a(this.owner,this);this.revoke=a(this.revoke,this);this.member=a(this.member,this);this.ban=a(this.ban,this);this.modifyAffiliation=a(this.modifyAffiliation,this);this.deop=a(this.deop,this);this.op=a(this.op,this);this.mute=a(this.mute,this);this.voice=a(this.voice,this);this.kick=a(this.kick,this);this.modifyRole=a(this.modifyRole,this);this.update(f)}e.prototype.modifyRole=function(j,h,f,g){return this.room.modifyRole(this.nick,j,h,f,g)};e.prototype.kick=function(h,f,g){return this.room.kick(this.nick,h,f,g)};e.prototype.voice=function(h,f,g){return this.room.voice(this.nick,h,f,g)};e.prototype.mute=function(h,f,g){return this.room.mute(this.nick,h,f,g)};e.prototype.op=function(h,f,g){return this.room.op(this.nick,h,f,g)};e.prototype.deop=function(h,f,g){return this.room.deop(this.nick,h,f,g)};e.prototype.modifyAffiliation=function(g,j,f,h){return this.room.modifyAffiliation(this.jid,g,j,f,h)};e.prototype.ban=function(h,f,g){return this.room.ban(this.jid,h,f,g)};e.prototype.member=function(h,f,g){return this.room.member(this.jid,h,f,g)};e.prototype.revoke=function(h,f,g){return this.room.revoke(this.jid,h,f,g)};e.prototype.owner=function(h,f,g){return this.room.owner(this.jid,h,f,g)};e.prototype.admin=function(h,f,g){return this.room.admin(this.jid,h,f,g)};e.prototype.update=function(f){this.nick=f.nick||null;this.affiliation=f.affiliation||null;this.role=f.role||null;this.jid=f.jid||null;this.status=f.status||null;this.show=f.show||null;return this};return e})()}).call(this);var Mustache=function(){var a=function(){};a.prototype={otag:"{{",ctag:"}}",pragmas:{},buffer:[],pragmas_implemented:{"IMPLICIT-ITERATOR":true},context:{},render:function(e,d,c,f){if(!f){this.context=d;this.buffer=[]}if(!this.includes("",e)){if(f){return e}else{this.send(e);return}}e=this.render_pragmas(e);var b=this.render_section(e,d,c);if(f){return this.render_tags(b,d,c,f)}this.render_tags(b,d,c,f)},send:function(b){if(b!==""){this.buffer.push(b)}},render_pragmas:function(b){if(!this.includes("%",b)){return b}var d=this;var c=new RegExp(this.otag+"%([\\w-]+) ?([\\w]+=[\\w]+)?"+this.ctag,"g");return b.replace(c,function(g,e,f){if(!d.pragmas_implemented[e]){throw ({message:"This implementation of mustache doesn't understand the '"+e+"' pragma"})}d.pragmas[e]={};if(f){var h=f.split("=");d.pragmas[e][h[0]]=h[1]}return""})},render_partial:function(b,d,c){b=this.trim(b);if(!c||c[b]===undefined){throw ({message:"unknown_partial '"+b+"'"})}if(typeof(d[b])!="object"){return this.render(c[b],d,c,true)}return this.render(c[b],d[b],c,true)},render_section:function(d,c,b){if(!this.includes("#",d)&&!this.includes("^",d)){return d}var f=this;var e=new RegExp(this.otag+"(\\^|\\#)\\s*(.+)\\s*"+this.ctag+"\n*([\\s\\S]+?)"+this.otag+"\\/\\s*\\2\\s*"+this.ctag+"\\s*","mg");return d.replace(e,function(h,j,g,l){var m=f.find(g,c);if(j=="^"){if(!m||f.is_array(m)&&m.length===0){return f.render(l,c,b,true)}else{return""}}else{if(j=="#"){if(f.is_array(m)){return f.map(m,function(n){return f.render(l,f.create_context(n),b,true)}).join("")}else{if(f.is_object(m)){return f.render(l,f.create_context(m),b,true)}else{if(typeof m==="function"){return m.call(c,l,function(n){return f.render(n,c,b,true)})}else{if(m){return f.render(l,c,b,true)}else{return""}}}}}}})},render_tags:function(l,b,d,f){var e=this;var j=function(){return new RegExp(e.otag+"(=|!|>|\\{|%)?([^\\/#\\^]+?)\\1?"+e.ctag+"+","g")};var g=j();var h=function(p,n,o){switch(n){case"!":return"";case"=":e.set_delimiters(o);g=j();return"";case">":return e.render_partial(o,b,d);case"{":return e.find(o,b);default:return e.escape(e.find(o,b))}};var m=l.split("\n");for(var c=0;c<m.length;c++){m[c]=m[c].replace(g,h,this);if(!f){this.send(m[c])}}if(f){return m.join("\n")}},set_delimiters:function(c){var b=c.split(" ");this.otag=this.escape_regex(b[0]);this.ctag=this.escape_regex(b[1])},escape_regex:function(c){if(!arguments.callee.sRE){var b=["/",".","*","+","?","|","(",")","[","]","{","}","\\"];arguments.callee.sRE=new RegExp("(\\"+b.join("|\\")+")","g")}return c.replace(arguments.callee.sRE,"\\$1")},find:function(c,d){c=this.trim(c);function b(f){return f===false||f===0||f}var e;if(b(d[c])){e=d[c]}else{if(b(this.context[c])){e=this.context[c]}}if(typeof e==="function"){return e.apply(d)}if(e!==undefined){return e}return""},includes:function(c,b){return b.indexOf(this.otag+c)!=-1},escape:function(b){b=String(b===null?"":b);return b.replace(/&(?!\w+;)|["'<>\\]/g,function(c){switch(c){case"&":return"&amp;";case"\\":return"\\\\";case'"':return"&quot;";case"'":return"&#39;";case"<":return"&lt;";case">":return"&gt;";default:return c}})},create_context:function(c){if(this.is_object(c)){return c}else{var d=".";if(this.pragmas["IMPLICIT-ITERATOR"]){d=this.pragmas["IMPLICIT-ITERATOR"].iterator}var b={};b[d]=c;return b}},is_object:function(b){return b&&typeof b=="object"},is_array:function(b){return Object.prototype.toString.call(b)==="[object Array]"},trim:function(b){return b.replace(/^\s*|\s*$/g,"")},map:function(f,d){if(typeof f.map=="function"){return f.map(d)}else{var e=[];var b=f.length;for(var c=0;c<b;c++){e.push(d(f[c]))}return e}}};return({name:"mustache.js",version:"0.3.1-dev",to_html:function(d,b,c,f){var e=new a();if(f){e.send=f}e.render(d,b,c);if(!f){return e.buffer.join("\n")}}})}();(function(a){a.i18n={dict:null,setDictionary:function(b){this.dict=b},_:function(d,c){var b=d;if(this.dict&&this.dict[d]){b=this.dict[d]}return this.printf(b,c)},toEntity:function(d){var b="";for(var c=0;c<d.length;c++){if(d.charCodeAt(c)>128){b+="&#"+d.charCodeAt(c)+";"}else{b+=d.charAt(c)}}return b},stripStr:function(b){return b.replace(/^\s*/,"").replace(/\s*$/,"")},stripStrML:function(d){var c=d.split("\n");for(var b=0;b<c.length;b++){c[b]=stripStr(c[b])}return stripStr(c.join(" "))},printf:function(g,b){if(!b){return g}var f="",e=/%(\d+)\$s/g;while(result=e.exec(g)){var c=parseInt(result[1],10)-1;g=g.replace("%"+result[1]+"$s",(b[c]));b.splice(c,1)}var h=g.split("%s");if(h.length>1){for(var d=0;d<b.length;d++){if(h[d].lastIndexOf("%")==h[d].length-1&&d!=b.length-1){h[d]+="s"+h.splice(d+1,1)[0]}f+=h[d]+b[d]}}return f+h[h.length-1]}};a.fn._t=function(c,b){return a(this).text(a.i18n._(c,b))}})(jQuery);Strophe.addConnectionPlugin("disco",{_connection:null,_identities:[],_features:[],_items:[],init:function(a){this._connection=a;this._identities=[];this._features=[];this._items=[];a.addHandler(this._onDiscoInfo.bind(this),Strophe.NS.DISCO_INFO,"iq","get",null,null);a.addHandler(this._onDiscoItems.bind(this),Strophe.NS.DISCO_ITEMS,"iq","get",null,null)},addIdentity:function(d,c,a,e){for(var b=0;b<this._identities.length;b++){if(this._identities[b].category==d&&this._identities[b].type==c&&this._identities[b].name==a&&this._identities[b].lang==e){return false}}this._identities.push({category:d,type:c,name:a,lang:e});return true},addFeature:function(b){for(var a=0;a<this._features.length;a++){if(this._features[a]==b){return false}}this._features.push(b);return true},removeFeature:function(b){for(var a=0;a<this._features.length;a++){if(this._features[a]===b){this._features.splice(a,1);return true}}return false},addItem:function(b,a,c,d){if(c&&!d){return false}this._items.push({jid:b,name:a,node:c,call_back:d});return true},info:function(c,d,g,b,e){var a={xmlns:Strophe.NS.DISCO_INFO};if(d){a.node=d}var f=$iq({from:this._connection.jid,to:c,type:"get"}).c("query",a);this._connection.sendIQ(f,g,b,e)},items:function(d,e,g,c,f){var b={xmlns:Strophe.NS.DISCO_ITEMS};if(e){b.node=e}var a=$iq({from:this._connection.jid,to:d,type:"get"}).c("query",b);this._connection.sendIQ(a,g,c,f)},_buildIQResult:function(c,b){var e=c.getAttribute("id");var d=c.getAttribute("from");var a=$iq({type:"result",id:e});if(d!==null){a.attrs({to:d})}return a.c("query",b)},_onDiscoInfo:function(e){var d=e.getElementsByTagName("query")[0].getAttribute("node");var a={xmlns:Strophe.NS.DISCO_INFO};if(d){a.node=d}var c=this._buildIQResult(e,a);for(var b=0;b<this._identities.length;b++){var a={category:this._identities[b].category,type:this._identities[b].type};if(this._identities[b].name){a.name=this._identities[b].name}if(this._identities[b].lang){a["xml:lang"]=this._identities[b].lang}c.c("identity",a).up()}for(var b=0;b<this._features.length;b++){c.c("feature",{"var":this._features[b]}).up()}this._connection.send(c.tree());return true},_onDiscoItems:function(g){var f={xmlns:Strophe.NS.DISCO_ITEMS};var e=g.getElementsByTagName("query")[0].getAttribute("node");if(e){f.node=e;var a=[];for(var c=0;c<this._items.length;c++){if(this._items[c].node==e){a=this._items[c].call_back(g);break}}}else{var a=this._items}var d=this._buildIQResult(g,f);for(var c=0;c<a.length;c++){var b={jid:a[c].jid};if(a[c].name){b.name=a[c].name}if(a[c].node){b.node=a[c].node}d.c("item",b).up()}this._connection.send(d.tree());return true}});Strophe.addConnectionPlugin("caps",{HASH:"sha-1",node:"http://strophe.im/strophejs/",_ver:"",_connection:null,_knownCapabilities:{},_jidVerIndex:{},init:function(a){this._connection=a;Strophe.addNamespace("CAPS","http://jabber.org/protocol/caps");if(!this._connection.disco){throw"Caps plugin requires the disco plugin to be installed."}this._connection.disco.addFeature(Strophe.NS.CAPS);this._connection.addHandler(this._delegateCapabilities.bind(this),Strophe.NS.CAPS)},generateCapsAttrs:function(){return{xmlns:Strophe.NS.CAPS,hash:this.HASH,node:this.node,ver:this.generateVer()}},generateVer:function(){if(this._ver!==""){return this._ver}var a="",c=this._connection.disco._identities.sort(this._sortIdentities),e=c.length,d=this._connection.disco._features.sort(),f=d.length;for(var b=0;b<e;b++){var g=c[b];a+=g.category+"/"+g.type+"/"+g.lang+"/"+g.name+"<"}for(var b=0;b<f;b++){a+=d[b]+"<"}this._ver=b64_sha1(a);return this._ver},getCapabilitiesByJid:function(a){if(this._jidVerIndex[a]){return this._knownCapabilities[this._jidVerIndex[a]]}return null},_delegateCapabilities:function(d){var f=d.getAttribute("from"),e=d.querySelector("c"),a=e.getAttribute("ver"),b=e.getAttribute("node");if(!this._knownCapabilities[a]){return this._requestCapabilities(f,b,a)}else{this._jidVerIndex[f]=a}if(!this._jidVerIndex[f]||!this._jidVerIndex[f]!==a){this._jidVerIndex[f]=a}return true},_requestCapabilities:function(d,b,a){if(d!==this._connection.jid){var c=this._connection.disco.info(d,b+"#"+a);this._connection.addHandler(this._handleDiscoInfoReply.bind(this),Strophe.NS.DISCO_INFO,"iq","result",c,d)}return true},_handleDiscoInfoReply:function(g){var e=g.querySelector("query"),d=e.getAttribute("node").split("#"),a=d[1],h=g.getAttribute("from");if(!this._knownCapabilities[a]){var f=e.childNodes,c=f.length;this._knownCapabilities[a]=[];for(var b=0;b<c;b++){var d=f[b];this._knownCapabilities[a].push({name:d.nodeName,attributes:d.attributes})}this._jidVerIndex[h]=a}else{if(!this._jidVerIndex[h]||!this._jidVerIndex[h]!==a){this._jidVerIndex[h]=a}}return false},_sortIdentities:function(d,c){if(d.category>c.category){return 1}if(d.category<c.category){return -1}if(d.type>c.type){return 1}if(d.type<c.type){return -1}if(d.lang>c.lang){return 1}if(d.lang<c.lang){return -1}return 0}});var dateFormat=function(){var a=/d{1,4}|m{1,4}|yy(?:yy)?|([HhMsTt])\1?|[LloSZ]|"[^"]*"|'[^']*'/g,b=/\b(?:[PMCEA][SDP]T|(?:Pacific|Mountain|Central|Eastern|Atlantic) (?:Standard|Daylight|Prevailing) Time|(?:GMT|UTC)(?:[-+]\d{4})?)\b/g,d=/[^-+\dA-Z]/g,c=function(f,e){f=String(f);e=e||2;while(f.length<e){f="0"+f}return f};return function(j,x,t){var g=dateFormat;if(arguments.length==1&&Object.prototype.toString.call(j)=="[object String]"&&!/\d/.test(j)){x=j;j=undefined}j=j?new Date(j):new Date;if(isNaN(j)){throw SyntaxError("invalid date")}x=String(g.masks[x]||x||g.masks["default"]);if(x.slice(0,4)=="UTC:"){x=x.slice(4);t=true}var v=t?"getUTC":"get",p=j[v+"Date"](),e=j[v+"Day"](),l=j[v+"Month"](),r=j[v+"FullYear"](),u=j[v+"Hours"](),n=j[v+"Minutes"](),w=j[v+"Seconds"](),q=j[v+"Milliseconds"](),f=t?0:j.getTimezoneOffset(),h={d:p,dd:c(p),ddd:g.i18n.dayNames[e],dddd:g.i18n.dayNames[e+7],m:l+1,mm:c(l+1),mmm:g.i18n.monthNames[l],mmmm:g.i18n.monthNames[l+12],yy:String(r).slice(2),yyyy:r,h:u%12||12,hh:c(u%12||12),H:u,HH:c(u),M:n,MM:c(n),s:w,ss:c(w),l:c(q,3),L:c(q>99?Math.round(q/10):q),t:u<12?"a":"p",tt:u<12?"am":"pm",T:u<12?"A":"P",TT:u<12?"AM":"PM",Z:t?"UTC":(String(j).match(b)||[""]).pop().replace(d,""),o:(f>0?"-":"+")+c(Math.floor(Math.abs(f)/60)*100+Math.abs(f)%60,4),S:["th","st","nd","rd"][p%10>3?0:(p%100-p%10!=10)*p%10]};return x.replace(a,function(m){return m in h?h[m]:m.slice(1,m.length-1)})}}();dateFormat.masks={"default":"ddd mmm dd yyyy HH:MM:ss",shortDate:"m/d/yy",mediumDate:"mmm d, yyyy",longDate:"mmmm d, yyyy",fullDate:"dddd, mmmm d, yyyy",shortTime:"h:MM TT",mediumTime:"h:MM:ss TT",longTime:"h:MM:ss TT Z",isoDate:"yyyy-mm-dd",isoTime:"HH:MM:ss",isoDateTime:"yyyy-mm-dd'T'HH:MM:ss",isoUtcDateTime:"UTC:yyyy-mm-dd'T'HH:MM:ss'Z'"};dateFormat.i18n={dayNames:["Sun","Mon","Tue","Wed","Thu","Fri","Sat","Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"],monthNames:["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec","January","February","March","April","May","June","July","August","September","October","November","December"]};Date.prototype.format=function(a,b){return dateFormat(this,a,b)};